proposed.individual<-0
temp.contact.time<-0
indiv.prop.ctc<-0
recovered<-0
err<-0
Rt1<-matrix(data = NA, nrow = 1, ncol = 2)
Rt2<-matrix(data = NA, nrow = 1, ncol = 2)
while((sum(infectives)>0 & current.time<t.stop) | current.time<t2){ #while there are still infectives
#Phase 1: individuals that has to, propose a new social contac
for (i in which(index.contact.within==1) ){ # for all the individuals that has to propose a global contact
contact.time.within$pr.ctc[i]<-rexp(1,transmission.parameters$contact_rate_within[i])+current.time# I generate the next interarrival time for individual i
index.contact.within[i]<-0
}
for (i in which(index.contact.between==1) ){ # for all the individuals that has to propose a global contact
contact.time.between$pr.ctc[i]<-rexp(1,transmission.parameters$contact_rate_between[i])+current.time# I generate the next interarrival time for individual i
index.contact.between[i]<-0
}
contact.time.overall<-c(contact.time.within$pr.ctc, contact.time.between$pr.ctc) #overall contact times
recovery.vector.overall<-c(status.matrix.1$Recovery ,status.matrix.2$Recovery)
homequarantine.day.overall<-c(homequarantine.day.1,homequarantine.day.2)
#Phase 2: identify the next event: possible infection, recovery or the start of the new pathogen infection
ifelse(length(which(is.na(contact.time.overall)==FALSE))>0,events$NextCtc<-min(contact.time.overall, na.rm = T),events$NextCtc<-Inf) # among all the proposed social contact between houeholds we select the minimum
ifelse(length(which(!is.infinite(homequarantine.day.overall)))>0,events$HomeQuarantine<-min(homequarantine.day.overall),events$HomeQuarantine<-Inf ) #minimum quarantine pathogen 1
ifelse(length(which(is.na(recovery.vector.overall)==FALSE))>0,events$Recovery<-min(recovery.vector.overall, na.rm = T),events$Recovery<-Inf) # among all the proposed social contact between houeholds we select the minimum
next.evts<-colnames(events)[which(min(events)==events)]
if (length(next.evts)>1){
next.evts<-sample(colnames(events)[which(min(events)==events)],1)
}
if (next.evts=="NextCtc"){
current.time<-events$NextCtc
if (length(min(contact.time.overall, na.rm = T))>1){ #when two contacts happen at the same time
selected.ctc<-sample(which(contact.time.overall==current.time),1)
if (selected.ctc!=n & selected.ctc!=2*n){
infector<- selected.ctc %% n
}else{
infector<- n
}
if (selected.ctc<=n){
infectee.pool<-get.neighborhood(HH.network,infector)
if (length(infectee.pool)>1){
infectee<-sample(infectee.pool,1) #pick a random individual in the class
}
if(length(infectee.pool)==1){
infectee<-infectee.pool #pick a random individual in the class
}
if(length(infectee.pool)==0){
infectee<-infector #just a trick to have acceptance rate 0 (infector is not susceptible)
}
index.contact.within[infector]<-1
contact.time.within$pr.ctc[infector]<-NA
ctc<-"hh"
}else{
infector<-which(contact.time.between$pr.ctc == events$NextCtc)
hh.members.temp<-which(hh.id==hh.id[infector])
infectee.pool<- setdiff(1:n,hh.members.temp) #individuals not in the same class
infectee<-sample(infectee.pool,1) #pick a random individual not in the class (and not a teacher)
index.contact.between[infector]<-1
contact.time.between$pr.ctc[infector]<-NA
ctc<-"g"
}
}else{
if (length(which(events$NextCtc==contact.time.within$pr.ctc))>0){ #if it is a within contact
infector<-which(contact.time.within$pr.ctc ==events$NextCtc)
infectee.pool<-get.neighborhood(HH.network,infector)
if (length(infectee.pool)>1){
infectee<-sample(infectee.pool,1) #pick a random individual in the class
}
if(length(infectee.pool)==1){
infectee<-infectee.pool #pick a random individual in the class
}
if(length(infectee.pool)==0){
infectee<-infector #just a trick to have acceptance rate 0 (infector is not susceptible)
}
index.contact.within[infector]<-1
contact.time.within$pr.ctc[infector]<-NA
ctc<-"hh"
}else{
infector<-which(contact.time.between$pr.ctc == events$NextCtc)
hh.members.temp<-which(hh.id==hh.id[infector])
infectee.pool<- setdiff(1:n,hh.members.temp) #individuals not in the same class
infectee<-sample(infectee.pool,1) #pick a random individual not in the class (and not a teacher)
index.contact.between[infector]<-1
contact.time.between$pr.ctc[infector]<-NA
ctc<-"g"
}
}
# compute short interaction terms for pathogen.1 (having pathogen 2)
if (status.matrix.2$infected[infectee]==1){
short.inter<-sigma12
}else{
short.inter<-1
}
# compute long interaction terms for pathogen.1 (recovered from pathogen 2)
if (status.matrix.2$infected[infectee]==-1 & lli.2==1){
long.inter<-long.inter.term.2(t=current.time,status.matrix = status.matrix.2,infectee = infectee)
}else{
long.inter<-1
}
#re-infection term
re.inf<-Immlev.1(t=current.time,status.matrix = status.matrix.1,infectee = infectee,pathogen = pathogen.1)
ifelse(ctc=="g",q<-transmission.parameters$q1g[infector],q<-transmission.parameters$q1h[infector])
acc.rate.1<-InfMeasure(t= current.time- status.matrix.1$time.of.infection[infector] ,pathogen = pathogen.1)*short.inter*long.inter*q*re.inf
if ((ctc=="g" & homequarantine[infectee]==1) | status.matrix.1$infected[infector]!=1){acc.rate.1<-0}
if (acc.rate.1>1){err<-err+1}
if (runif(1)<acc.rate.1){
status.matrix.1$infected[infectee] <- 1
status.matrix.1$time.of.infection[infectee] <- current.time
status.matrix.1$infector[infectee] <- infector
status.matrix.1$Recovery[infectee]<-current.time+infectious.period.length(pathogen=pathogen.1)
if (runif(1)<rho.1){ #if symptomatic
transmission.parameters$q1h[infectee]<-inf.path.1.h #A single q parameter for everyone
transmission.parameters$q1g[infectee]<-inf.path.1.g #A single q parameter for everyone
status.matrix.1$TimeSymptomOnset[infectee]<-current.time+incubation.period(pathogen=pathogen.1)
homequarantine.day.1[infectee]<-status.matrix.1$TimeSymptomOnset[infectee]
status.matrix.1$severity[infectee]<-1
time.events<-rbind(time.events,c(current.time,1.1,infectee))
}else{
transmission.parameters$q1g[infectee]<-inf.path.1.g*alpha.as.1 #A single q parameter for everyone
transmission.parameters$q1h[infectee]<-inf.path.1.h*alpha.as.1 #A single q parameter for everyone
status.matrix.1$severity[infectee]<-2
time.events<-rbind(time.events,c(current.time,1.2,infectee))
}
if (infectives[infectee]==0){
infectives[infectee]<-1
contact.time.within$pr.ctc[infectee]<-ifelse(transmission.parameters$contact_rate_within[infectee]!=0,rexp(1,transmission.parameters$contact_rate_within[infectee])+current.time,Inf)       # I generate the next interarrival time for individual i
if (homequarantine[infectee]==0){
contact.time.between$pr.ctc[infectee]<-rexp(1,transmission.parameters$contact_rate_between[infectee])+current.time # I generate the next interarrival time for individual i
}
}
}
# compute the long and short interaction terms for pathogen.2
if (status.matrix.1$infected[infectee]==1){
short.inter<-sigma21
}else{
short.inter<-1
}
if (status.matrix.1$infected[infectee]==-1 & lli.1==1){
long.inter<-long.inter.term.1(t=current.time,status.matrix = status.matrix.1,infectee = infectee)
}else{
long.inter<-1
}
#re-infection term
re.inf<-Immlev.2(t=current.time,status.matrix = status.matrix.2,infectee = infectee,pathogen = pathogen.2)
ifelse(ctc=="g",q<-transmission.parameters$q2g[infector],q<-transmission.parameters$q2h[infector])
acc.rate.2<-InfMeasure(t=(current.time-status.matrix.2$time.of.infection[infector]),pathogen = pathogen.2)*short.inter*long.inter*q*re.inf
if ((ctc=="g" & homequarantine[infectee]==1) | status.matrix.2$infected[infector]!=1){acc.rate.2<-0}
if (acc.rate.2>1){err<-err+1}
if (runif(1)<acc.rate.2){
status.matrix.2$infected[infectee] <- 1
status.matrix.2$time.of.infection[infectee] <- current.time
status.matrix.2$infector[infectee] <- infector
status.matrix.2$Recovery[infectee]<-current.time+infectious.period.length(pathogen=pathogen.2)
if (runif(1)<rho.2){ #if symptomatic
transmission.parameters$q2h[infectee]<-inf.path.2.h #A single q parameter for everyone
transmission.parameters$q2g[infectee]<-inf.path.2.g #A single q parameter for everyone
status.matrix.2$TimeSymptomOnset[infectee]<-current.time+incubation.period(pathogen=pathogen.2)
homequarantine.day.2[infectee]<-status.matrix.2$TimeSymptomOnset[infectee]
status.matrix.2$severity[infectee]<-1
time.events<-rbind(time.events,c(current.time,2.1,infectee))
}else{
transmission.parameters$q2g[infectee]<-inf.path.2.g*alpha.as.2 #A single q parameter for everyone
transmission.parameters$q2h[infectee]<-inf.path.2.h*alpha.as.2 #A single q parameter for everyone
status.matrix.2$severity[infectee]<-2
time.events<-rbind(time.events,c(current.time,2.2,infectee))
}
if (infectives[infectee]==0){
infectives[infectee]<-1
contact.time.within$pr.ctc[infectee]<-ifelse(transmission.parameters$contact_rate_within[infectee]!=0,rexp(1,transmission.parameters$contact_rate_within[infectee])+current.time,Inf)       # I generate the next interarrival time for individual i
if (homequarantine[infectee]==0){
contact.time.between$pr.ctc[infectee]<-rexp(1,transmission.parameters$contact_rate_between[infectee])+current.time # I generate the next interarrival time for individual i
}
}
}
}
if (next.evts=="HomeQuarantine"){
current.time<-events$HomeQuarantine
quarantined.individuals<-which(homequarantine.day.overall==current.time)
for (k in quarantined.individuals){
if (k != n & k!= 2*n) {
temp.ind<- k %% n
}else{
temp.ind<-n
}
if (k>n){
homequarantine.day.2[temp.ind]<-Inf
stop.quarantine[temp.ind]<-status.matrix.2$Recovery[temp.ind]
}else{
homequarantine.day.1[temp.ind]<-Inf
stop.quarantine[temp.ind]<-status.matrix.1$Recovery[temp.ind]
}
if (homequarantine[temp.ind]==1){ #individual is already in quarantine for the other disease
stop.quarantine[temp.ind]<-max(status.matrix.2$Recovery[temp.ind],status.matrix.1$Recovery[temp.ind])
}
homequarantine[temp.ind]<-1
contact.time.between$pr.ctc[temp.ind]<-NA
index.contact.between[temp.ind]<-0
transmission.parameters$contact_rate_within[temp.ind]<-transmission.parameters$contact_rate_within[temp.ind]*contact.reduction
}
}
if (next.evts=="Recovery"){
current.time<-events$Recovery
temp.recovered<-which(recovery.vector.overall==events$Recovery)
for (recovered in temp.recovered){
if (recovered!= n & recovered!=n*2){
if (recovered > n){
recovered<- recovered %% n
Rt2<-comp.RT(status.matrix = status.matrix.2,individual = recovered,Rt=Rt2)
status.matrix.2$infected[recovered]<--1
status.matrix.2$Recovery[recovered]<-Inf
transmission.parameters$contact_rate_within[recovered]<-length(get.neighborhood(HH.network,recovered))
time.events<-rbind(time.events,c(current.time,-2,recovered))
if (status.matrix.1$infected[recovered]!=1){
infectives[recovered]<-0
contact.time.between$pr.ctc[recovered]<-NA
contact.time.within$pr.ctc[recovered]<-NA
index.contact.within[recovered]<-0
index.contact.between[recovered]<-0
}else{
if (homequarantine[recovered]==0){
index.contact.between[recovered]<-1
}
}
}else{
Rt1<-comp.RT(status.matrix = status.matrix.1,individual = recovered,Rt=Rt1)
status.matrix.1$infected[recovered]<--1
status.matrix.1$Recovery[recovered]<-Inf
transmission.parameters$contact_rate_within[recovered]<-length(get.neighborhood(HH.network,recovered))
time.events<-rbind(time.events,c(current.time,-1,recovered))
if (status.matrix.2$infected[recovered]!=1){
infectives[recovered]<-0
contact.time.between$pr.ctc[recovered]<-NA
contact.time.within$pr.ctc[recovered]<-NA
index.contact.within[recovered]<-0
index.contact.between[recovered]<-0
}else{
if (homequarantine[recovered]==0){
index.contact.between[recovered]<-1
}
}
}
}else{
if (recovered == 2*n){
recovered<- n
Rt2<-comp.RT(status.matrix = status.matrix.2,individual = recovered,Rt=Rt2)
status.matrix.2$infected[recovered]<--1
status.matrix.2$Recovery[recovered]<-Inf
transmission.parameters$contact_rate_within[recovered]<-length(get.neighborhood(HH.network,recovered))
time.events<-rbind(time.events,c(current.time,-2,recovered))
if (status.matrix.1$infected[recovered]!=1){
infectives[recovered]<-0
contact.time.between$pr.ctc[recovered]<-NA
contact.time.within$pr.ctc[recovered]<-NA
index.contact.within[recovered]<-0
index.contact.between[recovered]<-0
}else{
if (homequarantine[recovered]==0){
index.contact.between[recovered]<-1
}
}
}else{
Rt1<-comp.RT(status.matrix = status.matrix.1,individual = recovered,Rt=Rt1)
status.matrix.1$infected[recovered]<--1
status.matrix.1$Recovery[recovered]<-Inf
transmission.parameters$contact_rate_within[recovered]<-length(get.neighborhood(HH.network,recovered))
time.events<-rbind(time.events,c(current.time,-1,recovered))
if (status.matrix.2$infected[recovered]!=1){
infectives[recovered]<-0
contact.time.between$pr.ctc[recovered]<-NA
contact.time.within$pr.ctc[recovered]<-NA
index.contact.within[recovered]<-0
index.contact.between[recovered]<-0
}else{
if (homequarantine[recovered]==0){
index.contact.between[recovered]<-1
}
}
}
}
if (stop.quarantine[recovered]==current.time){
homequarantine[recovered]<-0
stop.quarantine[recovered]<-Inf
}
}
}
if (next.evts=="NewPathogen"){
current.time<-events$NewPathogen
events$NewPathogen<-Inf
first.cases<-sample(1:n,nSeeds.2)
for (j in first.cases){
first<-j
status.matrix.2$infected[first] <- 1
status.matrix.2$time.of.infection[first] <- current.time
status.matrix.2$Recovery[first]<-current.time+infectious.period.length(pathogen=pathogen.2)
if (runif(1)<rho.2){ #if symptomatic
transmission.parameters$q2h[first]<-inf.path.2.h #A single q parameter for everyone
transmission.parameters$q2g[first]<-inf.path.2.g #A single q parameter for everyone
status.matrix.2$severity[first]<-1
status.matrix.2$TimeSymptomOnset[first]<-current.time+incubation.period(pathogen=pathogen.2)
homequarantine.day.2[first]<-status.matrix.2$TimeSymptomOnset[first]
time.events<-rbind(time.events,c(current.time,2.1,first))
}else{
transmission.parameters$q2h[first]<-inf.path.2.h*alpha.as.1 #A single q parameter for everyone
transmission.parameters$q2g[first]<-inf.path.2.g*alpha.as.1 #A single q parameter for everyone
status.matrix.2$severity[first]<-2
time.events<-rbind(time.events,c(current.time,2.2,first))
}
if (infectives[first]==0){
infectives[first]<-1
contact.time.within$pr.ctc[first]<-ifelse(transmission.parameters$contact_rate_within[first]!=0,rexp(1,transmission.parameters$contact_rate_within[first])+current.time,Inf)       # I generate the next interarrival time for individual i
if (homequarantine[first]==0){
contact.time.between$pr.ctc[first]<-rexp(1,transmission.parameters$contact_rate_between[first])+current.time # I generate the next interarrival time for individual i
}
}
}
}
}
infectee
infector
status.matrix.1[10,]
InfMeasure(t= current.time- status.matrix.1$time.of.infection[infector] ,pathogen = pathogen.1)
*short.inter
short.inter
long.inter
q
re.inf
Immlev.1(t=current.time,status.matrix = status.matrix.1,infectee = infectee,pathogen = pathogen.1)
Immlev.1<-function(t,status.matrix,infectee,pathogen){
if (status.matrix$infected[infectee]==1){
value<-0
}else{
if (pathogen == "COVID-19"){
if (status.matrix$infected[infectee]==0){
if (status.matrix$Immunity[infectee]==1){
time.since.inf<-t
if (time.since.inf<14){
value<-0
}
if (time.since.inf>=14 & time.since.inf <28){
value<-(1-0.951)
}
if (time.since.inf>=28 & time.since.inf <63){
value<-(1-0.918)
}
if (time.since.inf>=63){
value<-(1-0.899)
}
}else{
value<-1
}
}else{
if (status.matrix$Immunity[infectee]==1){
time.since.inf<-t-status.matrix$time.of.infection[infectee]
if (time.since.inf<14){
value<-0
}
if (time.since.inf>=14 & time.since.inf <28){
value<-(1-0.951)
}
if (time.since.inf>=28 & time.since.inf <63){
value<-(1-0.918)
}
if (time.since.inf>=63){
value<-(1-0.899)
}
}else{
time.since.inf<-t-status.matrix$time.of.infection[infectee]
if (time.since.inf<14){
value<-0
}
if (time.since.inf>=14 & time.since.inf <28){
value<-(1-0.909)
}
if (time.since.inf>=28 & time.since.inf <63){
value<-(1-0.855)
}
if (time.since.inf>=63 & time.since.inf <98){
value<-(1-0.787)
}
if (time.since.inf>=98 & time.since.inf <133){
value<-(1-0.744)
}
if (time.since.inf>=133 & time.since.inf <168){
value<-(1-0.674)
}
if (time.since.inf>=168){
value<-(1-0.627)
}
}
}
}
if (pathogen == "FLU-A"){
if (status.matrix$infected[infectee]==0){
if (status.matrix$Immunity[infectee]==1){
value<-(1-0.7)
}else{
value<-1
}
}else{
value<-0
}
}
}
return(value)
}
Immlev.2<-function(t,status.matrix,infectee,pathogen){
if (status.matrix$infected[infectee]==1){
value<-0
}else{
if (pathogen == "COVID-19"){
if (status.matrix$infected[infectee]==0){
if (status.matrix$Immunity[infectee]==1){
time.since.inf<-t
if (status.matrix$Immunity[infectee]==1){
if (time.since.inf<14){
value<-(1-0.669)
}
if (time.since.inf>=14 & time.since.inf <28){
value<-(1-0.672)
}
if (time.since.inf>=28 & time.since.inf <63){
value<-(1-0.55)
}
if (time.since.inf>=63){
value<-(1-0.457)
}
}
}else{
value<-1
}
}else{
if (status.matrix$Immunity[infectee]==1){
time.since.inf<-t-status.matrix$time.of.infection[infectee]
if (time.since.inf<14){
value<-0
}
if (time.since.inf>=14 & time.since.inf <28){
value<-(1-0.951)
}
if (time.since.inf>=28 & time.since.inf <63){
value<-(1-0.918)
}
if (time.since.inf>=63){
value<-(1-0.899)
}
}else{
time.since.inf<-t-status.matrix$time.of.infection[infectee]
if (time.since.inf<14){
value<-0
}
if (time.since.inf>=14 & time.since.inf <28){
value<-(1-0.909)
}
if (time.since.inf>=28 & time.since.inf <63){
value<-(1-0.855)
}
if (time.since.inf>=63 & time.since.inf <98){
value<-(1-0.787)
}
if (time.since.inf>=98 & time.since.inf <133){
value<-(1-0.744)
}
if (time.since.inf>=133 & time.since.inf <168){
value<-(1-0.674)
}
if (time.since.inf>=168){
value<-(1-0.627)
}
}
}
}
if (pathogen == "FLU-A"){
if (status.matrix$infected[infectee]==0){
if (status.matrix$Immunity[infectee]==1){
value<-1-0.7
}else{
value<-1
}
}else{
value<-0
}
}
}
return(value)
}
Immlev.1(t=current.time,status.matrix = status.matrix.1,infectee = infectee,pathogen = pathogen.1)
status.matrix.1[infectee,]
status.matrix<-status.matrix.1
status.matrix$infected[infectee]==1
pathogen == "COVID-19"
pathogen<-pathogen.1
pathogen == "COVID-19"
current.time
status.matrix$infected[infectee]==0
status.matrix$Immunity[infectee]==1
time.since.inf<-t
time.since.inf<-t
time.since.inf<-t
t
time.since.inf<-current.time
#Compute the reproduction number related to the selected network.
source("function.multipathogen.new.R")
nSim<-100
epi.outbreak<-list()
nSeed<-1062021
set.seed(nSeed)
nm<-paste("t2_",t2, "_sigma12_",sigma12,"_sigma21_",sigma21,"_qh1_",inf.path.1.h,"_qg1_",inf.path.1.g,"_qh2_",inf.path.2.h,"_qg2_",inf.path.2.g, "_rho1_",rho.1,"_rho2_",rho.2,"_alpha1_",alpha.as.1,"_alpha2_",alpha.as.2,"_Path1",pathogen.1,"_Path2",pathogen.2,"_lli.1",lli.1,"_lli2",lli.2, sep = "")
print(nm)
for (i in 1:nSim){
print(i)
temp.HH.netw<-HH.networks[[sample(1:length(HH.networks),1)]]
epi.outbreak[[i]]<-sim.multipathogen(HH.network = temp.HH.netw, t2=t2, lambda.g = lambda.g, sigma12 = sigma12, sigma21 = sigma21, prop.immune = prop.immune, nSeeds.1 = nSeeds.1, nSeeds.2 = nSeeds.2, rho.1 = rho.1, rho.2 = rho.2, inf.path.1.h = inf.path.1.h,inf.path.1.g = inf.path.1.g, inf.path.2.h = inf.path.2.h,inf.path.2.g = inf.path.2.g, alpha.as.1=alpha.as.1,alpha.as.2=alpha.as.2, lli.1=lli.1,lli.2=lli.2, pathogen.1=pathogen.1, pathogen.2=pathogen.2, contact.reduction=contact.reduction, t.stop=t.stop)
}
